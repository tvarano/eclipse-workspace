package managers;

import java.awt.Color;
import java.awt.Dimension;
import java.awt.Font;
import java.awt.Graphics;
import java.awt.Menu;
import java.awt.MenuBar;
import java.awt.MenuItem;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileWriter;
import java.io.IOException;
import java.util.Scanner;

import javax.swing.BorderFactory;
import javax.swing.JFrame;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.UIManager;
import javax.swing.UnsupportedLookAndFeelException;
import javax.swing.border.Border;
import javax.swing.border.TitledBorder;
import javax.swing.plaf.metal.MetalLookAndFeel;
import javax.swing.plaf.metal.OceanTheme;

import constants.ErrorID;
import constants.RotationConstants;
import ioFunctions.SchedWriter;

//Thomas Varano
public class UIHandler {
//	public static Color foreground, background, titleBorderColor, secondary, tertiary, titleColor, quaternary;

	public static Font font;
	public static String fontFam;
	private static boolean debug;
	
	public static void init() { 
	   debug = false;
	   font = new Font("Georgia", Font.PLAIN, 16);
	   fontFam = "Georgia";
	   setLAF();
	   setColors();
	   putValues();
	}
	
   public static JPanel getLoadingPanel() {
      JPanel retval = new JPanel() {
         private static final long serialVersionUID = 1L;
         
         @Override
         protected void paintComponent(Graphics g) {
            System.out.println("CALLED PAINT");
            setBackground(Color.BLUE);
            super.paintComponent(g);
         }
         public Dimension getMinimumSize() {
            return new Dimension(Main.MIN_W,Main.MIN_H);
         }
         public Dimension getPreferredSize() {
            return new Dimension(Main.PREF_W, Main.PREF_H);
         }
      };
      retval.setVisible(true);
      retval.repaint();
      return retval;
   }
	
   public static JFrame createEmptyLoad() {
      return new JFrame(Main.APP_NAME + " " + Main.BUILD);
   }
   
	public static JFrame createLoadingScreen(JFrame f) {
	   f.setTitle(Main.APP_NAME + " " + Main.BUILD);
	   JPanel p = getLoadingPanel();
	   f.getContentPane().add(p);
	   f.setMinimumSize(new Dimension(Main.MIN_W, Main.MIN_H));
	   f.pack();
	   f.setLocationRelativeTo(null);
	   f.setVisible(true);
	   return f;
	}
	
	public static void putValues() {
	   UIManager.put("List.selectionBackground", tertiary);
	   UIManager.put("List.selectionForeground", foreground);
	   UIManager.put("ToolTip.font", getToolTipFont());
	   UIManager.put("Button.disabledText", secondary);
	   UIManager.put("OptionPane.font", getButtonFont());
	}
	
	//TODO menu ideas... change color scheme, maybe font.
	// have a help tab which would describe where the log is and my email
	
	private static class ThemeChooser extends MenuItem {
      private static final long serialVersionUID = 1L;

      public ThemeChooser(String themeName) {
	      super(themeName);
	      addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
               try {
                  BufferedWriter bw = new BufferedWriter(new FileWriter(SchedWriter.RESOURCE_ROUTE+"theme.txt"));
                  bw.write(themeName);
                  bw.close();
                  // TODO have a restart button
                  if (JOptionPane.showOptionDialog(null,
                        "Changing the theme requires a restart", Main.APP_NAME,
                        JOptionPane.YES_NO_OPTION,
                        JOptionPane.INFORMATION_MESSAGE, null,
                        new String[]{"Restart", "Close"}, "Close") == 0)
                     Main.restart();
               } catch (IOException e1) {
                  ErrorID.showError(e1, true);
               }
            } 
	      });
	   }
	}
	
	public static final String[] themes = {"Clean (Default)", "Dark Mode", "Neutral", "Muted", "Colorful", "Minimal"}; 
	
   private static boolean checkIntentions(String action) {
      return (JOptionPane.showOptionDialog(null,
            "You are about to:\n" + action
                  + ".\nAre you sure you want to do this?",
            Main.APP_NAME, JOptionPane.YES_NO_OPTION, JOptionPane.WARNING_MESSAGE, null, new String[] {"Yes","No"}, "No") == 0);
	}
	
	public synchronized static MenuBar configureMenuBar(JFrame frame) {
      MenuBar bar = new MenuBar();
      Menu m = new Menu("Time Left In Class: ");
      bar.add(m);
      
      m = new Menu("File");
      m.addSeparator();
      MenuItem mi = m.add(new MenuItem("Reset Schedule"));
      mi.addActionListener(new ActionListener() {
         @Override
         public void actionPerformed(ActionEvent e) {
            if (checkIntentions("Reset your schedule")) {
               SchedWriter s = new SchedWriter();
               s.write(RotationConstants.defaultSchedule());
               Main.restart();
            }
         }
      });
      mi = m.add(new MenuItem("Restart"));
      mi.addActionListener(new ActionListener() {
         @Override
         public void actionPerformed(ActionEvent e) {
            if (checkIntentions("Restart the applicaiton"))
               Main.restart();
         }
      });
      bar.add(m);
      
      m = new Menu("View");
      Menu themes = (Menu)m.add(new Menu("Theme"));
      for (String str : UIHandler.themes) {
         themes.add(new ThemeChooser(str));
      }
      bar.add(m);
      
      
      m = new Menu("Help");
      mi = m.add(new MenuItem("Error Help"));
      mi.addActionListener(new ActionListener() {
         @Override
         public void actionPerformed(ActionEvent e) {
            JOptionPane.showMessageDialog(null, 
                  "Error logging helps the efficiency and ease of use for \n"
                  + "this program. Logs are kept at:\n"
                  + SchedWriter.LOG_ROUTE + "\n"
                  + "and keep internal information about the program as it runs.\n"
                  + "If an error occurs, its message will be printed in the log.\n"
                  + "The best thing to do is simply send the entire log when this\n"
                  + "occurs. It gives the most information possible and will allow\n"
                  + "for the error to be fixed most quickly.\n"
                  + "Email the log to varanoth@pascack.org", 
                  Main.APP_NAME, JOptionPane.INFORMATION_MESSAGE, null);
         }
      });
      mi = m.add(new MenuItem("Sharing Protocol"));
      mi.addActionListener(new ActionListener() {
         @Override
         public void actionPerformed(ActionEvent e) {
            JOptionPane.showMessageDialog(null, 
                  "To share this application, please share the entire folder\n"
                  + "this application came in. The program comes with a README\n"
                  + "file, which will help users who do not have all the \n"
                  + "necessary items on their computer for running this program.",
                  Main.APP_NAME, JOptionPane.INFORMATION_MESSAGE, null);
         }
      });
      bar.setHelpMenu(m);
      frame.setMenuBar(bar);
      if (debug) System.out.println("BARUI "+ bar);
      return bar;
	}
	
	/**
    * used for text
    */
   public static Color foreground;
   /**
    * used for a vast majority of backgrounds, is the solid back
    */
   public static Color background;
   /**
    * used for the borders of titled borders. 
    */
   public static Color titleBorderColor;
   /**
    * used as background of list and disabled buttons
    */
   public static Color secondary;
   /**
    * used for highlights - JMenubar, selected items in list, etc
    */
   public static Color tertiary;
   /**
    * background for info panes, tabs, etc
    */
   public static Color quaternary;
   /**
    * used for the titles of titled borders.
    */
   public static Color titleColor;
	
	public static void setColors() {
	   String theme = themes[0];
	   try {
	      Scanner s = new Scanner(new File(SchedWriter.RESOURCE_ROUTE+"theme.txt"));
	      String str = s.nextLine();
	      for (String th : themes)
	         if (str.equals(th))
	            theme = str;
	      s.close();
	      
	   } catch (IOException e) {
	      ErrorID.showError(e, true);
	      if (e instanceof FileNotFoundException) {
	         try {
               BufferedWriter bw = new BufferedWriter(new FileWriter(new File(SchedWriter.RESOURCE_ROUTE+"theme.txt")));
               bw.write(themes[0]);
               bw.close();
            } catch (IOException e1) {
               ErrorID.showError(e1, true);
            }
	      }
	   }
	   //TODO account for themes
	   Color text = null;
	   if (theme.equals(themes[0])) {
//	   if (false) {
	      text = new Color(40,40,40);
      	   Color noir = new Color(Integer.decode("#1d2731"));
      	   Color carbon = new Color(Integer.decode("#a9a9a9"));
      	   Color sky = new Color(Integer.decode("#caebf2"));
      	   Color watermelon = new Color(Integer.decode("#ff6a5c"));
      	   Color neutral = new Color(Integer.decode("#efefef"));
      	   
      	   background = neutral;
      	   secondary = carbon;
      	   tertiary = watermelon;
      	   quaternary = sky;
      	   titleColor = noir;
      	   titleBorderColor = carbon;
	   } else if (theme.equals(themes[1])) {
//	   } else if (true) {
	      text = new Color(238, 238, 238);
	      Color noir = new Color(Integer.decode("#1d2731"));
	      Color navy = new Color(25,40,55);
	      Color eggplant = new Color(145, 110, 180);
	      
	      Color salmon = new Color(Integer.decode("#d48872"));
	      Color royal = new Color(0,144,221);
	      Color gray = new Color(Integer.decode("#5a666b"));
	      Color indigo = new Color(13, 74, 108);
	      //13 74 108
	      
	      background = noir;
	      //FIXME no
	      secondary = gray;
	      tertiary = navy;
	      quaternary = navy;
	      titleColor = royal;
	      titleBorderColor = indigo;
	   }
	   
	   foreground = text;
	   
	   
	   
	}
	
	public static Color mutateColor(Color o, int diff) {
	   int[] newRGB = cap255(o.getRed(), o.getGreen(), o.getBlue(), diff); 
	   return new Color(newRGB[0], newRGB[1], newRGB[2], o.getAlpha());
	}
	
	private static int[] cap255(int r, int g, int b, int diff) {
	   int max = Math.max(Math.max(r, g), b);
	   if (max + diff > 255)
	      diff = 255 - max;
	   return new int[] {r + diff, g + diff, b + diff};
	}
	
	public static void setLAF() {
      try {
         UIManager.setLookAndFeel(UIManager.getCrossPlatformLookAndFeelClassName());
         MetalLookAndFeel.setCurrentTheme(new OceanTheme());   
         if (Main.statusU) Main.log("LAF set: "+UIManager.getLookAndFeel().getID());
      } catch (ClassNotFoundException | InstantiationException
            | IllegalAccessException | UnsupportedLookAndFeelException e1) {
         e1.printStackTrace();
      }
      if (debug) System.out.println("UI DONE");
	}
	
	public static Border getTitledBorder(String title, int justification, int position) {
      return BorderFactory.createTitledBorder(BorderFactory.createLineBorder(titleBorderColor, 2),
            title, justification, position, font, titleColor);
	}
	
	private static Font getBold(float size) {
	   return font.deriveFont(size).deriveFont(Font.BOLD);
	}
	
	public static Border getTitledBorder(String title) {
	   return getTitledBorder(title, TitledBorder.LEADING, TitledBorder.ABOVE_TOP);
	}
	
	public static Font getInputLabelFont() {
	   return getBold(14F);
	}
	
	public static Font getInputFieldFont() {
	   return getInputLabelFont().deriveFont(Font.PLAIN);
	}
	
	public static Font getTabFont() {
	   return getButtonFont();
	}
	
	public static Font getButtonFont() {
	   return getBold(12F);
	}
	
	public static Font getToolTipFont() {
	   return font.deriveFont(13F);
	}
}
