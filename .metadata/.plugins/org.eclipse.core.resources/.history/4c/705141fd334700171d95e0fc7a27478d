import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;
import java.util.Scanner;

import javax.swing.Timer;

//Thomas Varano
//[Program Descripion]
//Apr 15, 2017

public class LevelManager
implements ActionListener
{
   public static final String CUTSCENE = "cutscene", LVLONE = "level1", LVLTWO = "level2"; 
   public static final String LVLOPEN = "high", MAIN = "main", ALT = "alt_main", HAM = "lolly", WIN = "kirby";
   public static final String[] SOUNDS = {LVLOPEN, MAIN, CUTSCENE, ALT, HAM, WIN};
   public static final float VOL = 0, MUTE_VOL = -80;
   public static String currentSong = MAIN;
   public final String highScoreFile = System.getProperty("user.home")+"/Documents/DonkeyKongHighScore.txt";
   private KongFrame frame;
   private int level, lives, score, highScore;
   private boolean firstPlay, gameOver, resetCutscene;
   public static boolean mute;
   private OpeningCutscene cutscene;
   private long counter;
   private LevelOne lvlOne;
   private LevelTwo lvlTwo;
   private Timer timer = new Timer(50,this);
   
   public LevelManager(KongFrame frame){
      this.frame = frame;
      level = 0;
      lives = 3;
      score = 0;
      firstPlay = resetCutscene = true;
      lvlOne = new LevelOne();
      lvlTwo = new LevelTwo();
      readHighScore();
      cutscene = new OpeningCutscene(level,true);
      cutscene.setHeader(1, lives, score, highScore);
      initSounds();

      frame.c.setLayout(frame.layout);
      frame.c.add(CUTSCENE,cutscene); frame.c.add(LVLONE,lvlOne); frame.c.add(LVLTWO, lvlTwo);
      frame.layout.show(frame.c, CUTSCENE);
      cutscene.requestFocus();
      frame.pack();
      timer.start();
   }
   
   public void initSounds(){
      JukeBox.init();
      JukeBox.load("DKHowHigh3.wav", LVLOPEN);      
      JukeBox.load("dkMain.wav", MAIN);
      JukeBox.load("kelpyGLoopable.wav", ALT);
      JukeBox.load("kirbyLolly.wav", HAM);
      JukeBox.load("kirbyVictory.wav", WIN);
      for (String s : SOUNDS) {
         JukeBox.setVolume(s, VOL);
      }
   }
   
   public static void toggleMute() {
      mute = !mute;
      if (mute) 
         for (String s : SOUNDS) 
            JukeBox.setVolume(s, MUTE_VOL);
      else 
         for (String s : SOUNDS) 
            JukeBox.setVolume(s, VOL);
      System.out.println("mute toggled to: "+ mute);
   }
   
   public void die(){
      Level l = (level == 1) ? lvlOne : lvlTwo;
//      if (level == 3)
         //level = 3
      if (resetCutscene){
         JukeBox.pause(MAIN);
         cutscene.restart();
         lives--;
         resetCutscene = false;
      }
      cutscene.setHeader(level, lives, score, highScore);
      frame.layout.show(frame.c, CUTSCENE);
      if(cutscene.isDone()){
         l.restart();
         l.setHeader(lives, score, highScore);
         frame.layout.show(frame.c, "level"+level);
         cutscene.restart();
         resetCutscene = true;
      }
   }
 /*  
//   public void lvlOneOperations(){
//      score = lvlOne.getScore();
//      if (counter == 0){
//         System.out.println("COUNTERNOW");
//         lvlOne.restart();
//      }
//      else if (counter == 1){
//         lvlOne.setHeader(lives, score, highScore);
//      }
//      if (counter>1 && lvlOne.isDead()){
//         lvlOne.getPlayer().setLives(lives);
//         die();
//      }
//      else if (lvlOne.done){
//         score+=lvlOne.score;
//         score = lvlOne.getScore();
//         cutscene.setLevel(2);
//      }
//      counter++;
//   }
//   
//   public void lvlTwoOperations(){
//      if (counter == 0){
//         System.out.println("COUNTERNOW");
//         lvlTwo = new LevelTwo();
//      }
//      else if (counter == 1){
//         lvlTwo.setHeader(lives, score, highScore);
//      }
//      if (counter>1 && lvlOne.isDead()){
//         lvlTwo.getPlayer().setLives(lives);
//         die();
//      }
//      else if (lvlTwo.done){
//         score+=lvlTwo.score;
//         score = lvlTwo.getScore();
//         cutscene.setLevel(3);
//      }
//      counter++;
//   }
*/
   
   public void operations(){
      Level l = null;
      if (level == 1)
         l = lvlOne;
      else if (level == 2)
         l = lvlTwo;
      if (counter == 0){
         System.out.println("COUNTERNOW");
         l.restart();
         if (lives == 3)
            JukeBox.loop(MAIN);
         else
            JukeBox.resumeLoop(MAIN);
      }
      else if (counter == 1){
         l.setHeader(lives, score, highScore);
      }
      if (counter>1 && l.isDead()){
         l.getPlayer().setLives(lives);
         die();
      }
      else if (l.done){
         JukeBox.stop(MAIN);
         if (resetCutscene){
            cutscene.restart();
            lives--;
            resetCutscene = false;
            cutscene.setLevel(level+1);
         }
         score+=l.score;
         score = l.getScore();
         frame.layout.show(frame.c,CUTSCENE);
         if (cutscene.isDone()){
            System.out.println("??");
            level++;
            frame.layout.show(frame.c, "level"+level);
            System.out.println("level"+level);
            resetCutscene = true;
            l.getTimer().stop();
         }
      }
      counter++;
   }
   
   public void update(){
      gameOver = (lives == 0);
      if (gameOver)
         System.out.println("gameover");
      
      if (level == 0){
         if (cutscene.isDone()){
            level++;
            frame.layout.show(frame.c, LVLONE);
            firstPlay = false;
         }
      }
      
      if (level == 1){
         lvlOne.requestFocus();
         operations();
      }
      if (level == 2){
         lvlTwo.requestFocus();
         operations();
      }
   }
   
   public void readHighScore()
   {     
      File filePath = new File(highScoreFile);
      try{
         System.out.println("Reading high score.");
         @SuppressWarnings("resource")
         Scanner dataGetter = new Scanner(filePath);
         highScore = dataGetter.nextInt();
      }
      catch (FileNotFoundException e){
         System.out.println("Creating high score file.");
         try
         {
            PrintWriter pw = new PrintWriter(new FileWriter(highScoreFile, false));
            pw.println(0);
            pw.close();
            highScore = 0;
         } catch (IOException e1){e1.printStackTrace();}
      }
   }

   public void setScores()
   {
      if(score>highScore){
         highScore = score;
//         String userName = (String)JOptionPane.showInputDialog(null, "You got a High Score!\nWrite your name.",
//               "High Score!",
//               JOptionPane.PLAIN_MESSAGE,
//               null,
//               null,
//               "----");
         try
         {
            System.out.println("Writing high score.");
            PrintWriter pw = new PrintWriter(new FileWriter(highScoreFile, false));
            pw.println(highScore);
//            pw.println(userName);
            pw.close();
         } catch (IOException e1){e1.printStackTrace();}
      }
   }
   
   public void methodSoIGetNoErrors(){
      System.out.println("aight");
   }

   @Override
   public void actionPerformed(ActionEvent e) {
      update();
   }
}
