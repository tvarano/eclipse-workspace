import java.awt.BorderLayout;
import java.awt.Dimension;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.time.DayOfWeek;
import java.time.LocalDate;
import java.time.LocalTime;

import javax.swing.JButton;
import javax.swing.JPanel;
import javax.swing.Timer;

//Thomas Varano
//Aug 31, 2017

//probably going to be the main hub of everything. whats going to open when you first run the program
public class ScheduleDisplay extends JPanel implements ActionListener
{
   private static final long serialVersionUID = 1L;
   private static final int PREF_W = 800, PREF_H = 600;
   private static final int MIN_W = 400, MIN_H = 175;
   private PanelManager parentManager;
   private Schedule mainSched, todaySched;
   private Rotation todayR;
   private DayOfWeek today;
//   private Lab[] labs;
   private Time currentTime;
   private CurrentClassPane westPane;
   private ToolBar toolbar;
   private ScheduleInfoSelector eastPane;
   private boolean updating;
   private boolean debug = true;
   private Timer timer;
//   private ClassInfoPane currentClassInfo, selectedClassInfo;
   
   public ScheduleDisplay(PanelManager parentManager) {
      setParentManager(parentManager);
      currentTime = new Time(LocalTime.now().getHour(), LocalTime.now().getMinute());
      today = LocalDate.now().getDayOfWeek();
      todayR = Rotation.getRotation(today);
      setLayout(new BorderLayout());
      initComponents();
     
      addComponents();
      update();
      timer = new Timer(5000, this);
      timer.start();
   }
   
   private void initComponents() {
      Reader reader = new Reader();
      mainSched = reader.readDefaultSchedule(); mainSched.setName("mainSched");
      todaySched = reader.readAndOrderSchedule(todayR); todaySched.setName("todaySched");
      eastPane = new ScheduleInfoSelector(todaySched, mainSched, this);
      westPane = new CurrentClassPane(new ClassPeriod(), todaySched, this);
      toolbar = new ToolBar(false, this);
      checkAndUpdateTime();
      westPane.setClassPeriod(findCurrentClass());
   }
   
   private void addComponents() {
      add(eastPane, BorderLayout.EAST);
      add(westPane, BorderLayout.CENTER);
      add(toolbar, BorderLayout.NORTH);
   }
   
   public void stop() {
      timer.stop();
   }
   
   public void resume() {
      timer.start();
   }
   
   public void reinitialize() {
      removeAll();
      initComponents();
      addComponents();
      resume();
   }
   
   public void checkAndUpdateTime() {
      currentTime = new Time(LocalTime.now().getHour(), LocalTime.now().getMinute());
      if (currentTime.getHour24() == 23 && currentTime.getMinute() > 55)
         checkAndUpdateDate();
      westPane.pushCurrentTime(currentTime);
   }
   
   public void checkAndUpdateDate() {
      today = LocalDate.now().getDayOfWeek();
   }
   
   public void pushTodaySchedule() {
      westPane.pushTodaySchedule(todaySched);
      eastPane.pushTodaySchedule(todaySched);
   }
   
   public ClassPeriod findCurrentClass(){
      for (Lab l : todaySched.getLabSlots())
         if (today.equals(l.getDay()))
            if (l.getTimeAtLab().contains(currentTime)) {
               westPane.pushClassPeriod(l.getTimeAtLab());
               return l.getTimeAtLab();
            }
      ClassPeriod[] cp = todaySched.getClasses();
      if (debug)
         System.out.println(currentTime);
      for (ClassPeriod c : cp) {
         if (c.contains(currentTime)) {
            if (!c.equals(westPane.getClassPeriod()))
               westPane.pushClassPeriod(c);
            return c;
         }
      }
      westPane.pushClassPeriod(null);
      return null;
   }
      
   public void update() {
      setUpdating(true);
      checkAndUpdateTime();
      findCurrentClass();
      repaint();
      setUpdating(false);
   }

   
   public Dimension getMinimumSize() {
      return new Dimension(MIN_W,MIN_H);
   }
   public Dimension getPreferredSize() {
      return new Dimension(PREF_W, PREF_H);
   }

   public Schedule getMainSched() {
      return mainSched;
   }
   public void setMainSched(Schedule mainSched) {
      this.mainSched = mainSched;
   }
   public Schedule getTodaySched() {
      return todaySched;
   }
   public Rotation getTodayR() {
      if (debug)
         System.out.println("TODAY R CALLED");
      return todayR;
   }
   public void setTodayR(Rotation todayR) {
      this.todayR = todayR;
      Reader.reorderClasses(todayR, todaySched, mainSched.getClasses());
      pushTodaySchedule();
      repaint();
   }

   public DayOfWeek getToday() {
      return today;
   }

   public void setToday(DayOfWeek today) {
      this.today = today;
   }

   public PanelManager getParentManager() {
      return parentManager;
   }

   public void setParentManager(PanelManager parentManager) {
      this.parentManager = parentManager;
   }

   public boolean isUpdating() {
      return updating;
   }

   public void setUpdating(boolean updating) {
      this.updating = updating;
   }

   @Override
   public void actionPerformed(ActionEvent e) {
      if (e.getSource() instanceof Timer) {
         update();
      }
      else if (e.getSource() instanceof JButton) {
         parentManager.startInput(mainSched);
      }
   }
   
}
